<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>02 - Overview of fmlr • fmlr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="02 - Overview of fmlr">
<meta property="og:description" content="fmlr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fmlr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2-1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-installation.html">01 - Installation Guide</a>
    </li>
    <li>
      <a href="../articles/02-overview.html">02 - Overview of fmlr</a>
    </li>
    <li>
      <a href="../articles/03-backends.html">03 - Managing Backends</a>
    </li>
    <li>
      <a href="../articles/04-data.html">04 - Data Management</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/fml-fam/fmlr/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>02 - Overview of fmlr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/fml-fam/fmlr/blob/master/docs/vignettes/02-overview.Rmd"><code>docs/vignettes/02-overview.Rmd</code></a></small>
      <div class="hidden name"><code>02-overview.Rmd</code></div>

    </div>

    
    
<style type="text/css">
pre.r {color: white; background-color: #3f3f3f;}

code, pre {background-color: #dee4ea;} /* output bg */
code a {color: #0071db;}
pre a {color: #5daffc;}

.fl      {color: #9090f9;}  /* literal */
.fu      {color: #FF9800;}  /* function */
.ch,.st  {color: #4dc100;}  /* string */
.kw      {color: #FFC107;}  /* keyword */
.co      {color: #9E9E9E;}  /* comment */

.message { color: #EEEEEE;   font-weight: bolder;}
.error   { color: #f44336;  font-weight: bolder;}
.warning { color: #9C27B0; font-weight: bolder;}
</style>
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>fmlr is an R interface to the <a href="https://github.com/fml-fam/fml">fml library</a>, a C++ library for dense matrix computing. fmlr is different from other similarly-scoped projects, including R itself in some pretty major ways. For one, we define a single interface for CPU, GPU, and distributed computing via MPI. This single interface also supports multiple types, not just <code>double</code> as R does. Also, operations occur in-place, which can greatly reduce the amount of memory needed for a computation.</p>
<p>The fmlr interface largely tracks with the core C++ fml interface. If the fmlr interface feels more like C++ than R, that is by design. While it may seem strange, there are numerous advantages to this approach. For a high-level interface on top of fmlr, see the <a href="https://github.com/fml-fam/craze">craze package</a>.</p>
</div>
<div id="quick-example-and-basic-usage" class="section level2">
<h2 class="hasAnchor">
<a href="#quick-example-and-basic-usage" class="anchor"></a>Quick Example and Basic Usage</h2>
<p>To keep things simple, in this article we will only be dealing with the simplest backend: the CPU backend. We also will ignore issues like fundamental type. We will discuss these issues in later articles. But note that other than object creation, all functions we describe will work <em>without modification</em> for any other combination of backends and fundamental types.</p>
<p>Most <em>fmlr</em> operations occur via side effects. Some functions can return objects as a matter of convenience, but generally you will need to initialize an object and apply functions/methods to it. A typical fmlr function may only return <code>NULL</code>, so the typical R pattern of forming repeated chains of:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">x</span> <span class="kw">=</span> <span class="fu">operate_on_data</span>(<span class="no">x</span>)</pre></body></html></div>
<p>should be avoided.</p>
<p>This approach has performance advantages, primarily in avoiding copies. But it is very different from how things normally work in R.</p>
<p>Anyway, let’s start with a basic 3x2 matrix:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">fmlr</span>))

<span class="no">x</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cpumat.html">cpumat</a></span>(<span class="fl">3</span>, <span class="fl">2</span>)
<span class="no">x</span>$<span class="fu">fill_linspace</span>(<span class="fl">1</span>, <span class="fl">6</span>)
<span class="no">x</span>$<span class="fu">info</span>()</pre></body></html></div>
<pre><code>## # cpumat 3x2 type=d</code></pre>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">x</span></pre></body></html></div>
<pre><code>## 1.0000 4.0000 
## 2.0000 5.0000 
## 3.0000 6.0000</code></pre>
<p>A concise R equivalent would look something like <code>x = matrix(1:6, 3)</code>. Obviously, fmlr is much more verbose. But we can do plenty of things that R can’t, but one thing at a time.</p>
<p>Here’s how we compute the singular values with fmlr:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">s</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cpuvec.html">cpuvec</a></span>()
<span class="fu"><a href="../reference/linalg-svd.html">linalg_svd</a></span>(<span class="no">x</span>, <span class="no">s</span>)

<span class="no">s</span>$<span class="fu">info</span>()</pre></body></html></div>
<pre><code>## # cpuvec 2 type=d</code></pre>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">s</span></pre></body></html></div>
<pre><code>## 9.5080 0.7729</code></pre>
<p>The R equivalent would be something like <code>s = svd(x, nu=0, nv=0)$d</code>. Concise, but not the prettiest either. In contrast, notice that with fmlr, we had to initialize the return before passing it to the <code><a href="../reference/linalg-svd.html">linalg_svd()</a></code> function.</p>
<p>Also, <code>s</code> is an fmlr vector - not an ordinary R vector. If we wanted to turn it into an R vector, we can do:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">s</span>$<span class="fu">to_robj</span>()</pre></body></html></div>
<pre><code>## [1] 9.5080320 0.7728696</code></pre>
<p>Keep in mind that this will create a copy of the data.</p>
<p>Finally, we note that when we call <code><a href="../reference/linalg-svd.html">linalg_svd()</a></code>, the data in the input <code>x</code> is overwritten but the underlying math library (in this case, LAPACK):</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">x</span></pre></body></html></div>
<pre><code>## -3.7417 -8.5524 
## 0.0000 1.9640 
## 0.6327 0.8598</code></pre>
<p>Destruction of input data is always documented, so be sure to check if that matters for your needs. If you need to preserve the input data, you would need to manually copy it before computing the SVD. How to do this is the subject of the next section.</p>
</div>
<div id="copying-data" class="section level2">
<h2 class="hasAnchor">
<a href="#copying-data" class="anchor"></a>Copying Data</h2>
<p>Assignment via <code>&lt;-</code> or <code>=</code> (or <code>-&gt;</code> for the weirdos) will only produce a “shallow copy”. It will not duplicate the data in memory. Observe:</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">x</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cpumat.html">cpumat</a></span>(<span class="fl">2</span>, <span class="fl">3</span>)
<span class="no">x</span>$<span class="fu">fill_linspace</span>(<span class="fl">1</span>, <span class="fl">2</span>)
<span class="no">x</span></pre></body></html></div>
<pre><code>## 1.0000 1.4000 1.8000 
## 1.2000 1.6000 2.0000</code></pre>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">y</span> <span class="kw">=</span> <span class="no">x</span>
<span class="no">y</span>$<span class="fu">fill_val</span>(<span class="no">pi</span>)
<span class="no">y</span></pre></body></html></div>
<pre><code>## 3.1416 3.1416 3.1416 
## 3.1416 3.1416 3.1416</code></pre>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">x</span></pre></body></html></div>
<pre><code>## 3.1416 3.1416 3.1416 
## 3.1416 3.1416 3.1416</code></pre>
<p>Here, there is only one allocation of memory representing a 2x3 matrix. That single allocation has two names, <code>x</code> and <code>y</code>. The data is literally exactly the same, so performing an operation on <code>y</code> will be witnessed on <code>x</code> as well.</p>
<p>Instead, if we need an actual duplicate, then we need to create a “deep copy”. We can do this via the <code>dupe()</code> method:</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">z</span> <span class="kw">=</span> <span class="no">x</span>$<span class="fu">dupe</span>()
<span class="no">x</span>$<span class="fu">fill_zero</span>()

<span class="no">x</span></pre></body></html></div>
<pre><code>## 0.0000 0.0000 0.0000 
## 0.0000 0.0000 0.0000</code></pre>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">y</span></pre></body></html></div>
<pre><code>## 0.0000 0.0000 0.0000 
## 0.0000 0.0000 0.0000</code></pre>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">z</span></pre></body></html></div>
<pre><code>## 3.1416 3.1416 3.1416 
## 3.1416 3.1416 3.1416</code></pre>
</div>
<div id="arbitrary-function-evaluation" class="section level2">
<h2 class="hasAnchor">
<a href="#arbitrary-function-evaluation" class="anchor"></a>Arbitrary Function Evaluation</h2>
<p>Unfortunately, this is not possible without writing custom C++. This is because the data is managed externally to R. The objects are all “external pointers”, which point to things in memory that R doesn’t understand.</p>
<p>A copy of the core fml library is included in the fmlr package source in <code>inst/include/fml</code>. If you wish to link with fml to create your own C++ kernels, you can add <code>LinkingTo: fml</code> to your R package DESCRIPTION file.</p>
<p>If you are unwilling or unable to create C++ kernels, you can move the data into R memory via any object’s <code>to_robj()</code> method. However, this is expensive in terms of both memory and run-time performance, and should be avoided if possible.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Drew Schmidt.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
