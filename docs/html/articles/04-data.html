<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>04 - Data Management • fmlr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="04 - Data Management">
<meta property="og:description" content="fmlr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fmlr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2-1-1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-installation.html">01 - Installation Guide</a>
    </li>
    <li>
      <a href="../articles/02-overview.html">02 - Overview of fmlr</a>
    </li>
    <li>
      <a href="../articles/03-backends.html">03 - Managing Backends</a>
    </li>
    <li>
      <a href="../articles/04-data.html">04 - Data Management</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/fml-fam/fmlr/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>04 - Data Management</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/fml-fam/fmlr/blob/master/docs/vignettes/04-data.Rmd"><code>docs/vignettes/04-data.Rmd</code></a></small>
      <div class="hidden name"><code>04-data.Rmd</code></div>

    </div>

    
    
<style type="text/css">
pre.r {color: white; background-color: #3f3f3f;}

code, pre {background-color: #dee4ea;} /* output bg */
code a {color: #0071db;}
pre a {color: #5daffc;}

.fl      {color: #9090f9;}  /* literal */
.fu      {color: #FF9800;}  /* function */
.ch,.st  {color: #4dc100;}  /* string */
.kw      {color: #FFC107;}  /* keyword */
.co      {color: #9E9E9E;}  /* comment */

.message { color: #EEEEEE;   font-weight: bolder;}
.error   { color: #f44336;  font-weight: bolder;}
.warning { color: #9C27B0; font-weight: bolder;}
</style>
<div id="converting-between-fmlr-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#converting-between-fmlr-objects" class="anchor"></a>Converting Between fmlr Objects</h2>
<p>Converting between fmlr objects is simple to do using the various helper functions. Let’s start with a simple matrix on the CPU:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">fmlr</span>))

<span class="no">x_cpu</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cpumat.html">cpumat</a></span>(<span class="fl">2</span>, <span class="fl">2</span>)
<span class="no">x_cpu</span>$<span class="fu">fill_linspace</span>(<span class="fl">1</span>, <span class="fl">4</span>)</pre></body></html></div>
<p>We can distribute the data to an <code>mpimat</code> object using <code><a href="../reference/cpu2mpi.html">cpu2mpi()</a></code>.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">g</span> <span class="kw">=</span> <span class="fu"><a href="../reference/grid.html">grid</a></span>()
<span class="no">x_mpi</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mpimat.html">mpimat</a></span>(<span class="no">g</span>)
<span class="fu"><a href="../reference/cpu2mpi.html">cpu2mpi</a></span>(<span class="no">x_cpu</span>, <span class="no">x_mpi</span>)
<span class="no">x_mpi</span></pre></body></html></div>
<pre><code>## 1.0000 3.0000 
## 2.0000 4.0000</code></pre>
<p>These are completely different kinds of objects, so there is no concept of “shallow copying” here. New storage will be allocated. Also note that running this in one process instead of launching the script with <code>mpirun</code> isn’t actually that useful (or even properly distributed). We only provide this for demonstration. See the <a href="docs/vignettes/03-backends.Rmd">article on backends</a> for more information.</p>
<p>Converting between objects works essentially the same as this for the various choices of backends. You just have to pick the right copy function.</p>
<ul>
<li>CPU objects
<ul>
<li>
<code><a href="../reference/cpu2cpu.html">cpu2cpu()</a></code> copy data between CPU objects (more on this in the next section)</li>
</ul>
</li>
<li>GPU objects
<ul>
<li>
<code><a href="../reference/cpu2gpu.html">cpu2gpu()</a></code> copy CPU matrix/vector data to a GPU matrix/vector</li>
<li>
<code><a href="../reference/gpu2cpu.html">gpu2cpu()</a></code> copy GPU matrix/vector data to a CPU matrix/vector</li>
<li>
<code><a href="../reference/gpu2gpu.html">gpu2gpu()</a></code> copy data between GPU objects</li>
</ul>
</li>
<li>MPI objects
<ul>
<li>
<code><a href="../reference/cpu2mpi.html">cpu2mpi()</a></code> distribute CPU matrix to an MPI matrix</li>
<li>
<code><a href="../reference/mpi2mpi.html">mpi2mpi()</a></code> copy data between MPI objects</li>
</ul>
</li>
</ul>
<p>It’s important to note that you have to initialize the object you wish to copy into first. That object can be just a “placeholder” (i.e., it can have 0 rows and columns). Some objects have additional objects they have to maintain (the return of <code><a href="../reference/grid.html">grid()</a></code> for <code>mpimat</code> objects and the return of <code><a href="../reference/card.html">card()</a></code> for <code>gpumat</code> and <code>gpuvec</code> objects). Since we can’t guess these, you have to specify them in the object creation, as in the example above where we called <code><a href="../reference/mpimat.html">mpimat(g)</a></code>. There was no underlying data allocated to the object until <code><a href="../reference/cpu2mpi.html">cpu2mpi()</a></code> was called. Of course, if you had already allocated the necessary data, then <code><a href="../reference/cpu2mpi.html">cpu2mpi()</a></code> would not have done any memory operations beyond the copy.</p>
</div>
<div id="fundamental-type" class="section level2">
<h2 class="hasAnchor">
<a href="#fundamental-type" class="anchor"></a>Fundamental Type</h2>
<p>When we talk about “fundamental type” of an object, we mean the kind of data the object represents. Right now there are three supported fundamental types for all objects:</p>
<ul>
<li>
<code>int</code> - 32-bit signed integer</li>
<li>
<code>float</code> - single precision</li>
<li>
<code>double</code> - double precision</li>
</ul>
<p>In the future, we plan to support <code>__half</code> for GPU objects, as the C++ fml does.</p>
<p>R supports <code>int</code> and <code>double</code> in their overloaded <code>numeric</code> type. The float package adds some support for <code>float</code> data. R also has some skeleton support for <code>double complex</code> for computing eigenvalues of non-symmetric matrices. We do not plan to ever support complex types.</p>
<p>In fmlr, all methods support <code>float</code> and <code>double</code>. Some methods will support <code>int</code>, but most will not. This is a major departure from normal R behavior. For example, if you wanted to compute the SVD of an integer matrix, R will automatically promote the <code>int</code> data to <code>double</code> without asking or telling you, and then perform the SVD on the <code>double</code> copy. This is because it doesn’t really make any sense to talk about an SVD of integer data most of the time. However, in fmlr, the <code><a href="../reference/linalg-svd.html">linalg_svd()</a></code> function will just throw an error:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">x</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cpumat.html">cpumat</a></span>(<span class="fl">3</span>, <span class="fl">2</span>, <span class="st">"int"</span>)
<span class="no">x</span>$<span class="fu">fill_linspace</span>(<span class="fl">1</span>, <span class="fl">6</span>)

<span class="no">s</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cpuvec.html">cpuvec</a></span>(<span class="kw">type</span><span class="kw">=</span><span class="st">"int"</span>)

<span class="fu"><a href="../reference/linalg-svd.html">linalg_svd</a></span>(<span class="no">x</span>, <span class="no">s</span>)</pre></body></html></div>
<pre><code>## Error in linalg_svd(x, s): unsupported fundamental type</code></pre>
<p>If you really do need to compute on the integer data, then you will need to manually copy it. Fortunately, this is easy. We just use the <code><a href="../reference/cpu2cpu.html">cpu2cpu()</a></code> helper:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">y</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cpumat.html">cpumat</a></span>(<span class="kw">type</span><span class="kw">=</span><span class="st">"f"</span>)
<span class="fu"><a href="../reference/cpu2cpu.html">cpu2cpu</a></span>(<span class="no">x</span>, <span class="no">y</span>)
<span class="no">y</span>$<span class="fu">info</span>()</pre></body></html></div>
<pre><code>## # cpumat 3x2 type=f</code></pre>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">y</span></pre></body></html></div>
<pre><code>## 1.0000 4.0000 
## 2.0000 5.0000 
## 3.0000 6.0000</code></pre>
<p>Since <code>y</code> has fundamental type <code>float</code>, it is using exactly as much memory as its <code>int</code> counterpart in <code>x</code>. If we had chosen <code>double</code> then it would require twice as much memory.</p>
<p>From here, computing the SVD is easy:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">s</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cpuvec.html">cpuvec</a></span>(<span class="kw">type</span><span class="kw">=</span><span class="st">"f"</span>)
<span class="fu"><a href="../reference/linalg-svd.html">linalg_svd</a></span>(<span class="no">y</span>, <span class="no">s</span>)
<span class="no">s</span>$<span class="fu">info</span>()</pre></body></html></div>
<pre><code>## # cpuvec 2 type=f</code></pre>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">s</span></pre></body></html></div>
<pre><code>## 9.5080 0.7729</code></pre>
<p>One other important caveat is that we can’t mix fundamental types for most methods. The converters, for example <code><a href="../reference/cpu2cpu.html">cpu2cpu()</a></code> as seen above, can mix fundamental types. But the compute functions like <code><a href="../reference/linalg-svd.html">linalg_svd()</a></code> will throw an error if we try to mix fundamental types.</p>
<p>As a final note, if we convert an fmlr object with fundamental type <code>float</code> to a native R object, it will be wrapped as a <code>float32</code> object from the float package:</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">s</span>$<span class="fu">to_robj</span>()</pre></body></html></div>
<pre><code>## # A float32 vector: 2
## [1] 9.50803 0.77287</code></pre>
</div>
<div id="converting-r-objects-into-fmlr-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#converting-r-objects-into-fmlr-objects" class="anchor"></a>Converting R Objects Into fmlr Objects</h2>
<p>Let’s start with a simple R matrix:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span>:<span class="fl">6</span>), <span class="fl">3</span>, <span class="fl">2</span>)
<span class="no">x</span></pre></body></html></div>
<pre><code>##          [,1]     [,2]
## [1,] 1.000000 2.000000
## [2,] 1.414214 2.236068
## [3,] 1.732051 2.449490</code></pre>
<p>We can convert this into an fmlr matrix using the object’s <code>from_robj()</code> method. For simplicity, we’ll just use a CPU matrix:</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">x_cpu</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cpumat.html">cpumat</a></span>()$<span class="fu">from_robj</span>(<span class="no">x</span>)
<span class="no">x_cpu</span></pre></body></html></div>
<pre><code>## 1.0000 2.0000 
## 1.4142 2.2361 
## 1.7321 2.4495</code></pre>
<p>This copy is a “deep copy”, in that the memory of the R object <code>x</code> and the fmlr object <code>x_cpu</code> are different. Observe:</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">x_cpu</span>$<span class="fu">fill_zero</span>()
<span class="no">x_cpu</span></pre></body></html></div>
<pre><code>## 0.0000 0.0000 
## 0.0000 0.0000 
## 0.0000 0.0000</code></pre>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">x</span></pre></body></html></div>
<pre><code>##          [,1]     [,2]
## [1,] 1.000000 2.000000
## [2,] 1.414214 2.236068
## [3,] 1.732051 2.449490</code></pre>
<p>The <code><a href="../reference/as_cpumat.html">as_cpumat()</a></code>function offers a shorthand for this operation, so you do not have to manually create the skeleton object:</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">x_cpu</span> <span class="kw">=</span> <span class="fu"><a href="../reference/as_cpumat.html">as_cpumat</a></span>(<span class="no">x</span>)
<span class="no">x</span></pre></body></html></div>
<pre><code>##          [,1]     [,2]
## [1,] 1.000000 2.000000
## [2,] 1.414214 2.236068
## [3,] 1.732051 2.449490</code></pre>
<p>However, for CPU matrices/vectors, there is a way to shallow copy. This allows us to create an fmlr object that merely inherits the same pointer that R is using. We can do this via the <code>inherit()</code> method, or by setting the argument <code>copy=FALSE</code> in <code><a href="../reference/as_cpumat.html">as_cpumat()</a></code>. However, care must be exercised when doing this because it can produce surprising results if you are not careful:</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="no">x_cpu</span> <span class="kw">=</span> <span class="fu"><a href="../reference/as_cpumat.html">as_cpumat</a></span>(<span class="no">x</span>, <span class="kw">copy</span><span class="kw">=</span><span class="fl">FALSE</span>)
<span class="no">x_cpu</span>$<span class="fu">fill_zero</span>()
<span class="no">x</span></pre></body></html></div>
<pre><code>##      [,1] [,2]
## [1,]    0    0
## [2,]    0    0
## [3,]    0    0</code></pre>
<p>Also, <strong>do not allow a reallocation to trigger on the inherited pointer</strong> as this will crash your R session.</p>
<p>All of the above is likewise true for numeric R vectors and <code>cpuvec</code> objects. Likewise, we can inherit shallow copies from <code>float32</code> objects (those from the float package).</p>
<p>For <code>gpumat</code> and <code>gpuvec</code>, we can not inherit data without a copy - because native R matrices/vectors do not live on GPUs. To copy R matrix data to a GPU, we can use <code><a href="../reference/cpu2gpu.html">cpu2gpu()</a></code>. But first, we have to have the R data represented as an fmlr object. Using <code><a href="../reference/as_cpumat.html">as_cpumat()</a></code> as above:</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span>:<span class="fl">6</span>), <span class="fl">3</span>, <span class="fl">2</span>)
<span class="no">x_cpu</span> <span class="kw">=</span> <span class="fu"><a href="../reference/as_cpumat.html">as_cpumat</a></span>(<span class="no">x</span>, <span class="kw">copy</span><span class="kw">=</span><span class="fl">FALSE</span>)

<span class="no">c</span> <span class="kw">=</span> <span class="fu"><a href="../reference/card.html">card</a></span>()
<span class="no">x_gpu</span> <span class="kw">=</span> <span class="fu"><a href="../reference/gpumat.html">gpumat</a></span>(<span class="no">c</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"float"</span>)
<span class="fu"><a href="../reference/cpu2gpu.html">cpu2gpu</a></span>(<span class="no">x_cpu</span>, <span class="no">x_gpu</span>)
<span class="no">x_gpu</span>$<span class="fu">info</span>()</pre></body></html></div>
<pre><code>## # gpumat 3x2 type=f </code></pre>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="no">x_gpu</span></pre></body></html></div>
<pre><code>## 1.0000 2.0000 
## 1.4142 2.2361 
## 1.7321 2.4495</code></pre>
<p>Note that the objects are actually of different fundamental type. The data we inherit from R is <code>double</code>, while the data on the GPU is <code>float</code>.</p>
</div>
<div id="converting-fmlr-objects-into-r-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#converting-fmlr-objects-into-r-objects" class="anchor"></a>Converting fmlr Objects Into R Objects</h2>
<p>We have already seen several examples of using the <code>to_robj()</code> method to copy data back to an R object. This operates via a deep copy.</p>
<p>For cases like the above where we had a shallow copy of an R object in a <code>cpumat</code> object, we can, for example, copy back from GPU memory to CPU memory without a copy. Observe:</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="no">x_gpu</span>$<span class="fu">fill_eye</span>()
<span class="fu"><a href="../reference/gpu2cpu.html">gpu2cpu</a></span>(<span class="no">x_gpu</span>, <span class="no">x_cpu</span>)
<span class="no">x</span></pre></body></html></div>
<pre><code>##      [,1] [,2]
## [1,]    1    0
## [2,]    0    1
## [3,]    0    0</code></pre>
<p>If <code>x</code> and <code>x_cpu</code> had used different memory, we could have copied back via:</p>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">x</span> <span class="kw">=</span> <span class="no">x_gpu</span>$<span class="fu">to_robj</span>()</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Drew Schmidt.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
