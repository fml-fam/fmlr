<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>03 - Managing Backends • fmlr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="03 - Managing Backends">
<meta property="og:description" content="fmlr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fmlr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4-0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-installation.html">01 - Installation Guide</a>
    </li>
    <li>
      <a href="../articles/02-overview.html">02 - Overview of fmlr</a>
    </li>
    <li>
      <a href="../articles/03-backends.html">03 - Managing Backends</a>
    </li>
    <li>
      <a href="../articles/04-data.html">04 - Data Management</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/fml-fam/fmlr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>03 - Managing Backends</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/fml-fam/fmlr/blob/master/docs/vignettes/03-backends.Rmd"><code>docs/vignettes/03-backends.Rmd</code></a></small>
      <div class="hidden name"><code>03-backends.Rmd</code></div>

    </div>

    
    
<style type="text/css">
pre.r {color: white; background-color: #3f3f3f;}

code, pre {background-color: #dee4ea;} /* output bg */
code a {color: #0071db;}
pre a {color: #5daffc;}

.fl      {color: #9090f9;}  /* literal */
.fu      {color: #FF9800;}  /* function */
.ch,.st  {color: #4dc100;}  /* string */
.kw      {color: #FFC107;}  /* keyword */
.co      {color: #9E9E9E;}  /* comment */

.message { color: #EEEEEE;   font-weight: bolder;}
.error   { color: #f44336;  font-weight: bolder;}
.warning { color: #9C27B0; font-weight: bolder;}
</style>
<div id="background" class="section level2">
<h2 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h2>
<p>Generally, codes should be easy to port between different backends (CPU, GPU, MPI). The difficulty/differences generally come in object creation.</p>
<p>To better understand this process, we’ll take a simple example and examine it across the different backends. We’ll create a 3x3 diagonal matrix with diagonal elements 1, 2, 3. In R, this would look something like:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>##      [,1] [,2] [,3]
## [1,]    1    0    0
## [2,]    0    2    0
## [3,]    0    0    3</code></pre>
<p>The fmlr version is going to be more verbose, but I promise you, there are many advantages to this approach - some of which will become more apparent in the later articles. Basically, with fmlr you get much better control over memory (which is very important in constrained environemtns, like GPUs).</p>
</div>
<div id="cpu" class="section level2">
<h2 class="hasAnchor">
<a href="#cpu" class="anchor"></a>CPU</h2>
<p>We’ll start with the CPU backend because these are the simplest to work with.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/fml-fam/fmlr">fmlr</a></span><span class="op">)</span><span class="op">)</span>

<span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="../reference/cpuvec.html">cpuvec</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="va">v</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">v</span></code></pre></div>
<pre><code>## 1.0000 2.0000 3.0000</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/cpumat.html">cpumat</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">x</span><span class="op">$</span><span class="fu">fill_diag</span><span class="op">(</span><span class="va">v</span><span class="op">)</span>
<span class="va">x</span></code></pre></div>
<pre><code>## 1.0000 0.0000 0.0000 
## 0.0000 2.0000 0.0000 
## 0.0000 0.0000 3.0000</code></pre>
<p>This looks very different from R’s built-in matrix interface. With fmlr, you have to manually create the object you want to work with, and then operate on it via side effects.</p>
<p>The skeleton for CPU object creation is:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="../reference/cpuvec.html">cpuvec</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">s</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # cpuvec 0 type=d</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/cpumat.html">cpumat</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">x</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # cpumat 0x0 type=d</code></pre>
</div>
<div id="gpu" class="section level2">
<h2 class="hasAnchor">
<a href="#gpu" class="anchor"></a>GPU</h2>
<p>For GPU objects, we need to first create a <code>card</code> object. This manages some internal GPU data. It is tied to a specific GPU (by ordinal ID), and you only need one object per GPU. You will need to pass this object to the <code><a href="../reference/gpuvec.html">gpuvec()</a></code> and <code><a href="../reference/gpumat.html">gpumat()</a></code> object constructors.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">c</span> <span class="op">=</span> <span class="fu"><a href="../reference/card.html">card</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">c</span></code></pre></div>
<pre><code>## ## GPU 0 (GeForce GTX 1070 Ti) 821/8116 MB - CUDA 10.1</code></pre>
<p>Now that we have our <code>card</code> object, things look similar to the CPU version, but with the addition of having to pass <code>c</code> to our object constructors:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="../reference/gpuvec.html">gpuvec</a></span><span class="op">(</span><span class="va">c</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">v</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">v</span></code></pre></div>
<pre><code>## 1.0000 2.0000 3.0000 </code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/gpumat.html">gpumat</a></span><span class="op">(</span><span class="va">c</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">x</span><span class="op">$</span><span class="fu">fill_diag</span><span class="op">(</span><span class="va">v</span><span class="op">)</span>
<span class="va">x</span></code></pre></div>
<pre><code>## 1.0000 0.0000 0.0000 
## 0.0000 2.0000 0.0000 
## 0.0000 0.0000 3.0000 </code></pre>
<p>Notice that we don’t have to do anything special to print from the device. Also, outside of the constructors, the code is identical to the CPU version. That is one of the major goals of fmlr.</p>
<p>The skeleton for GPU object creation is:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="../reference/gpuvec.html">gpuvec</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span>
<span class="va">s</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # gpuvec 0 type=d </code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/gpumat.html">gpumat</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span>
<span class="va">x</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # gpumat 0x0 type=d </code></pre>
</div>
<div id="mpi" class="section level2">
<h2 class="hasAnchor">
<a href="#mpi" class="anchor"></a>MPI</h2>
<p>Using MPI objects is a little different from the others. We can’t use them interactively and get parallelism at the same time. Instead, we have to write our script and launch it in batch with <code>mpirun</code>. If you want to better understand this programming model, called SPMD, then I recommend reading <a href="https://github.com/RBigData/tutorials/blob/master/content/pbdR/mpi.md">this tutorial</a>.</p>
<p>Like with GPU objects, we have an additional object to create first. Here, it’s a special MPI communicator grid. You can have different grids in a single program, but this is pretty advanced, so we won’t cover that here. We’ll just use one grid with the default arguments. We also have to specify a blocking factor. Choosing good values for this is beyond the scope of this example. We use a 1x1 blocking to make sure that all processes own some of the data. In practice, you would probably want blocking factors, say 16x16.</p>
<p>The added complexity here is because these matrix objects use the <a href="https://www.netlib.org/utk/papers/factor/node3.html">2-dimensional block-cyclic data distribution</a>. This is a fairly complicated thing to get used to. Discussions about the subtleties of this distribution go beyond the scope of this document. But if you are familiar with ScaLAPACK or <a href="https://pbdr.org">pbdR</a>, then this should be familiar.</p>
<p>Back to the example, first let’s writ out the script:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/fml-fam/fmlr">fmlr</a></span><span class="op">)</span><span class="op">)</span>

<span class="va">g</span> <span class="op">=</span> <span class="fu"><a href="../reference/grid.html">grid</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">g</span>

<span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="../reference/cpuvec.html">cpuvec</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="va">v</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="va">g</span><span class="op">$</span><span class="fu">rank0</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="va">v</span>

<span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/mpimat.html">mpimat</a></span><span class="op">(</span><span class="va">g</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">x</span><span class="op">$</span><span class="fu">fill_diag</span><span class="op">(</span><span class="va">v</span><span class="op">)</span>
<span class="va">x</span></code></pre></div>
<p>There are several differences from the previous examples. First, there is no <code>mpivec()</code> object. There’s usually no point in distributing a vector. Consider that if you have a 100,000x100,000 numeric matrix (of doubles), then that matrix would take up ~75 GiB of memory. Whereas a 100,000 length vector would use less than 1 MiB.</p>
<p>Another major difference is in printing. If we print a distributed object (<code>grid</code> or <code>mpimat</code>), then we just print it as normal. It will “do the right thing” for us. But if we want to print a non-distributed object (e.g., <code>cpumat</code>, regular R data, …), then we have to explicitly specify that we only want to print it on one rank. Typically, we choose rank 0 (or (0, 0) in the grid) to do the printing. That’s what <code>g$rank0()</code> is checking for us.</p>
<p>Ok, so we’re finally ready to run the script. Remember, we have to run it in batch. We can save it as, say, <code>fmlr_mpi.r</code>, and launch it via:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb22-1" title="1"><span class="ex">mpirun</span> -np 2 Rscript fmlr_mpi.r</a></code></pre></div>
<p>And this is the output we see:</p>
<pre><code>## ## Grid 0 2x1

## 1.0000 2.0000 3.0000 

## 1.0000 0.0000 0.0000 
## 0.0000 2.0000 0.0000 
## 0.0000 0.0000 3.0000 </code></pre>
<p>We should see the same output if we run the script with one rank via <code>Rscript mpi.r</code> (no parallelism) or with say 4 ranks via <code>mpirun -np 4 Rscript mpi.r</code>.</p>
<p>The skeleton for MPI object creation is:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/mpimat.html">mpimat</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span>
<span class="va">x</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # mpimat 0x0 with 16x16 blocking on 2x1 grid type=d</code></pre>
</div>
<div id="recap" class="section level2">
<h2 class="hasAnchor">
<a href="#recap" class="anchor"></a>Recap</h2>
<ul>
<li>Object creation varies a bit across the backends.</li>
<li>Beyond object creation, generally class methods and other functions should work identically across backends.</li>
<li>Printing MPI objects will automatically only print on rank (0, 0) of the grid. Printing non-MPI objects when using multiple ranks requires some care.</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Drew Schmidt.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
